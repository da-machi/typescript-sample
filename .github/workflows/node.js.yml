# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: Node.js CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: 18
        cache: 'npm'

    - run: npm ci

    - run: npm run build --if-present

    - name: Run Jest with JSON output
      run: npx jest --json --outputFile=jest-results.json

    - name: Show test summary in job summary
      id: summary
      run: |
        echo "## âŒ Failed Tests" > result.md
        # å¤±æ•—ãƒ†ã‚¹ãƒˆãŒãªã‘ã‚Œã°ãã®æ—¨ã‚’å‡ºåŠ›
        if [ $(jq '.numFailedTests' jest-results.json) -eq 0 ]; then
          echo "All tests passed! ğŸ‰" > result.md
        else
          echo "## âŒ Failed Tests" > result.md
          echo "| Test Name | Location |" >> result.md
          echo "| --------- | -------- |" >> result.md
          jq -r '
            .testResults[]
            | select(.status == "failed")
            | .assertionResults[]
            | select(.status=="failed")
            | ["| " + .fullName + " | " + (.location | tostring) + " |"]
            | @tsv
          ' jest-results.json >> result.md
        fi
        # ã‚¸ãƒ§ãƒ–ã‚µãƒãƒªãƒ¼ã«Markdownã‚’è¿½åŠ 
        cat result.md
        echo "::notice file=result.md::$(cat result.md)"
        echo "::set-output name=summary_file::result.md"

    - name: Upload job summary
      uses: actions/upload-artifact@v4
      with:
        name: jest-summary
        path: result.md

    - name: Add job summary markdown to GitHub UI
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('result.md', 'utf8');
          core.summary.addRaw(summary).write();
