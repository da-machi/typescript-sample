name: Node.js CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # ã‚³ãƒ¼ãƒ‰ã‚’ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
    - uses: actions/checkout@v4

    # Node.js 18 ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã€npmã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–
    - name: Use Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: 18
        cache: 'npm'

    # ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆpackage-lock.jsonã‚’å…ƒã«å³å¯†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼‰
    - run: npm ci

    # ãƒ“ãƒ«ãƒ‰å‡¦ç†ãŒã‚ã‚Œã°å®Ÿè¡Œ
    - run: npm run build --if-present

    # Jestã‚’JSONå‡ºåŠ›ä»˜ãã§å®Ÿè¡Œ
    # ãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã‚‚ã‚¸ãƒ§ãƒ–ã‚’æ­¢ã‚ãšã€å¾Œç¶šã§å‡¦ç†å¯èƒ½ã«ã™ã‚‹ãŸã‚ '|| true' ã‚’ä»˜ä¸
    - name: Run Jest with JSON output
      run: npx jest --json --outputFile=jest-results.json || true

    # ãƒ†ã‚¹ãƒˆçµæœJSONã‹ã‚‰å¤±æ•—ãƒ†ã‚¹ãƒˆã®ä¸€è¦§ã‚’Markdownå½¢å¼ã§ç”Ÿæˆã—ã€result.mdã«ä¿å­˜
    # å¤±æ•—ãŒç„¡ã‘ã‚Œã°ã€ŒAll tests passed! ğŸ‰ã€ã ã‘ã‚’è¨˜è¼‰
    # ã¾ãŸã€GITHUB_OUTPUTã«ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å‡ºåŠ›ã—ã¦å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã¸æ¸¡ã™
    - name: Show test summary in job summary
      id: summary
      run: |
        if [ $(jq '.numFailedTests' jest-results.json) -eq 0 ]; then
          echo "All tests passed! ğŸ‰" > result.md
        else
          echo "## âŒ Failed Tests" > result.md
          echo "| Suite (Describe) | Test Name | File | Location |" >> result.md
          echo "| ---------------- | --------- | ---- | -------- |" >> result.md
    
          jq -r '
            .testResults[]
            | .testFilePath as $file
            | .assertionResults[]
            | select(.status=="failed")
            | [
                (.ancestorTitles | join(" > ")),
                .fullName,
                $file,
                (if .location == null then "ï¼ˆå ´æ‰€æƒ…å ±ãªã—ï¼‰" else (.location | tostring) end)
              ]
            | @json
          ' jest-results.json | while read -r row; do
            suite=$(echo "$row" | jq -r '.[0]')
            name=$(echo "$row" | jq -r '.[1]')
            file=$(echo "$row" | jq -r '.[2]')
            loc=$(echo "$row" | jq -r '.[3]')
            printf "| %s | %s | %s | %s |\n" "$suite" "$name" "$file" "$loc" >> result.md
          done
    
          echo "" >> result.md
          echo "> â€» Locationåˆ—ã¯ãƒ†ã‚¹ãƒˆå†…ã®è¡Œãƒ»åˆ—æƒ…å ±ã‚’ç¤ºã—ã¾ã™ãŒã€" >> result.md
          echo "> ä¸€éƒ¨ã®ç’°å¢ƒï¼ˆä¾‹: ts-jestãªã©ï¼‰ã§ã¯å–å¾—ã§ããšã€Œï¼ˆå ´æ‰€æƒ…å ±ãªã—ï¼‰ã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚" >> result.md
        fi
    
        echo "summary_file=result.md" >> $GITHUB_OUTPUT
  
    # ç”Ÿæˆã—ãŸMarkdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
    - name: Upload job summary
      uses: actions/upload-artifact@v4
      with:
        name: jest-summary
        path: result.md

    # GitHub Actionsã®ã‚¸ãƒ§ãƒ–ã‚µãƒãƒªãƒ¼ã«Markdownå†…å®¹ã‚’åæ˜ 
    - name: Add job summary markdown to GitHub UI
      uses: actions/github-script@v6
      with:
        script: |
          // GitHub Actionsã®coreãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«æä¾›ã•ã‚Œã¦ã„ã‚‹ã®ã§ require ä¸è¦
          const fs = require('fs');
          const summary = fs.readFileSync('result.md', 'utf8');
          core.summary.addRaw(summary).write();
